# Sensitivity to Selection Criteria – Output Generation

Using the tabular output generated by `ssc_process`, this function will
build a graph to visualize the results. Each function configuration will
output a bespoke ggplot. Theming can be adjusted by the user after the
graph has been output using `+ theme()`. Most graphs can also be made
interactive using `make_interactive_squba()`

## Usage

``` r
ssc_output(
  process_output,
  alt_cohort_filter = NULL,
  large_n = FALSE,
  large_n_sites = NULL
)
```

## Arguments

- process_output:

  *tabular input* \|\| **required**

  The tabular output produced by `ssc_process`

- alt_cohort_filter:

  *string or vector* \|\| defaults to `NULL`

  A vector with the names of alternate cohorts to display in the output.
  This should be limited to 2 or less to maintain good visibility on the
  graph. This parameter is required for the following check types:

  - `Single Site, Exploratory, Cross-Sectional`

  - `Multi-Site, Exploratory, Cross-Sectional`

- large_n:

  *boolean* \|\| defaults to `FALSE`

  For Multi-Site analyses, a boolean indicating whether the large N
  visualization, intended for a high volume of sites, should be used.
  This visualization will produce high level summaries across all sites,
  with an option to add specific site comparators via the
  `large_n_sites` parameter.

- large_n_sites:

  *vector* \|\| defaults to `NULL`

  When `large_n = TRUE`, a vector of site names that can add site-level
  information to the plot for comparison across the high level summary
  information.

## Value

This function will produce a graph to visualize the results from
`ssc_process` based on the parameters provided. The default output is
typically a static ggplot or gt object, but interactive elements can be
activated by passing the plot through `make_interactive_squba`. For a
more detailed description of output specific to each check type, see the
PEDSpace metadata repository

## Examples

``` r
#' Source setup file
source(system.file('setup.R', package = 'sensitivityselectioncriteria'))

#' Create in-memory RSQLite database using data in extdata directory
conn <- mk_testdb_omop()

#' Establish connection to database and generate internal configurations
initialize_dq_session(session_name = 'ssc_process_test',
                      working_directory = my_directory,
                      db_conn = conn,
                      is_json = FALSE,
                      file_subdirectory = my_file_folder,
                      cdm_schema = NA)
#> Connected to: :memory:@NA
#> To see environment settings, run `get_argos_default()`

## silence SQL trace for this example
config('db_trace', FALSE)

#' Build mock base study cohort
base_cohort <- cdm_tbl('person') %>% dplyr::distinct(person_id) %>%
  dplyr::mutate(start_date = as.Date(-5000),
                #RSQLite does not store date objects,
                #hence the numerics
                end_date = as.Date(15000),
                site = ifelse(person_id %in% c(1:6), 'synth1', 'synth2'))

#' Build mock alternate study cohort
alt_cohort <- cdm_tbl('person') %>% dplyr::distinct(person_id) %>%
  head(100) %>%
  dplyr::mutate(start_date = as.Date(-5000),
                #RSQLite does not store date objects,
                #hence the numerics
                end_date = as.Date(15000),
                site = ifelse(person_id %in% c(1:6), 'synth1', 'synth2'))

#' Prepare input tables
ssc_domain_tbl <- dplyr::tibble(domain = c('all conditions', 'outpatient visits'),
                                domain_tbl = c('condition_occurrence', 'visit_occurrence'),
                                concept_field = c('condition_concept_id', 'visit_concept_id'),
                                date_field = c('condition_start_date', 'visit_start_date'),
                                vocabulary_field = c(NA, NA),
                                filter_logic = c(NA, 'visit_concept_id == 9202'))

ssc_outcome_tbl <- read_codeset('dx_hypertension') %>%
  dplyr::mutate(variable = 'hypertension', domain = 'all conditions')

#' Execute `ssc_process` function
#' This example will use the single site, exploratory, cross sectional
#' configuration
ssc_process_example <- ssc_process(base_cohort = base_cohort,
                                   alt_cohorts = list('Sample Alternate' = alt_cohort),
                                   omop_or_pcornet = 'omop',
                                   multi_or_single_site = 'single',
                                   anomaly_or_exploratory = 'exploratory',
                                   domain_tbl = ssc_domain_tbl,
                                   domain_select = c('all conditions', 'outpatient visits'),
                                   outcome_concepts = ssc_outcome_tbl) %>%
  suppressMessages()
#> Warning: Missing values are always removed in SQL aggregation functions.
#> Use `na.rm = TRUE` to silence this warning
#> This warning is displayed once every 8 hours.
#> ┌ Output Function Details ──────────────────────────────────────┐
#> │ You can optionally use this dataframe in the accompanying     │
#> │ `ssc_output` function. Here are the parameters you will need: │
#> │                                                               │
#> │ Always Required: process_output                               │
#> │ Required for Check: alt_cohort_filter                         │
#> │                                                               │
#> │ See ?ssc_output for more details.                             │
#> └───────────────────────────────────────────────────────────────┘

ssc_process_example
#> $summary_values
#> # A tibble: 28 × 7
#>    site  cohort_id cohort_characteristic fact_group fact_summary cohort_total_pt
#>    <chr> <chr>     <chr>                 <chr>             <dbl>           <int>
#>  1 comb… Sample A… median_age_cohort_en… Cohort De…       -12.0               12
#>  2 comb… Sample A… median_age_first_vis… Cohort De…         1.46              12
#>  3 comb… Sample A… median_all condition… Clinical …         0                 12
#>  4 comb… Sample A… median_fu             Cohort De…         0                 12
#>  5 comb… Sample A… median_outpatient vi… Utilizati…         0                 12
#>  6 comb… base_coh… median_age_cohort_en… Cohort De…       -12.0               12
#>  7 comb… base_coh… median_age_first_vis… Cohort De…         1.46              12
#>  8 comb… base_coh… median_all condition… Clinical …         0                 12
#>  9 comb… base_coh… median_fu             Cohort De…         0                 12
#> 10 comb… base_coh… median_outpatient vi… Utilizati…         0                 12
#> # ℹ 18 more rows
#> # ℹ 1 more variable: output_function <chr>
#> 
#> $cohort_overlap
#> # A tibble: 1 × 3
#>   site     cohort_group                 group_ct
#>   <chr>    <chr>                           <int>
#> 1 combined base_cohort&Sample Alternate       12
#> 

#' Execute `ssc_output` function
ssc_output_example <- ssc_output(process_output = ssc_process_example,
                                 alt_cohort_filter = 'Sample Alternate') %>%
  suppressMessages()
#> Warning: `aes_string()` was deprecated in ggplot2 3.0.0.
#> ℹ Please use tidy evaluation idioms with `aes()`.
#> ℹ See also `vignette("ggplot2-in-packages")` for more information.
#> ℹ The deprecated feature was likely used in the UpSetR package.
#>   Please report the issue to the authors.
#> Warning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.
#> ℹ Please use `linewidth` instead.
#> ℹ The deprecated feature was likely used in the UpSetR package.
#>   Please report the issue to the authors.
#> Warning: The `size` argument of `element_line()` is deprecated as of ggplot2 3.4.0.
#> ℹ Please use the `linewidth` argument instead.
#> ℹ The deprecated feature was likely used in the UpSetR package.
#>   Please report the issue to the authors.

ssc_output_example[[1]]

ssc_output_example[[2]]


#' Easily convert the graph into an interactive ggiraph or plotly object with
#' `make_interactive_squba()`

make_interactive_squba(ssc_output_example[[2]])
#> Warning: geom_GeomLabel() has yet to be implemented in plotly.
#>   If you'd like to see this geom implemented,
#>   Please open an issue with your example code at
#>   https://github.com/ropensci/plotly/issues
#> Warning: geom_GeomLabel() has yet to be implemented in plotly.
#>   If you'd like to see this geom implemented,
#>   Please open an issue with your example code at
#>   https://github.com/ropensci/plotly/issues

{"x":{"data":[{"orientation":"v","width":[0,0,0,0,0],"base":[0.55000000000000004,1.55,2.5499999999999998,3.5499999999999998,4.5499999999999998],"x":[0,0,0,0,0],"y":[0.89999999999999991,0.90000000000000013,0.90000000000000036,0.90000000000000036,0.90000000000000036],"text":["diff_base: 0<br />cf: all conditions<br />cohort_id: Sample Alternate","diff_base: 0<br />cf: age cohort entry<br />cohort_id: Sample Alternate","diff_base: 0<br />cf: age first visit<br />cohort_id: Sample Alternate","diff_base: 0<br />cf: follow-up<br />cohort_id: Sample Alternate","diff_base: 0<br />cf: outpatient visits<br />cohort_id: Sample Alternate"],"type":"bar","textposition":"none","marker":{"autocolorscale":false,"color":"rgba(255,77,111,1)","line":{"width":1.8897637795275593,"color":"transparent"}},"name":"Sample Alternate","legendgroup":"Sample Alternate","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null},{"orientation":"v","width":[0,0,0,0,0,0,0,0,0],"base":[0.55000000000000004,1.55,2.5499999999999998,3.5499999999999998,4.5499999999999998,5.5499999999999998,6.5499999999999998,7.5499999999999998,8.5500000000000007],"x":[0,0,0,0,0,0,0,0,0],"y":[0.89999999999999991,0.90000000000000013,0.90000000000000036,0.90000000000000036,0.90000000000000036,0.90000000000000036,0.90000000000000036,0.89999999999999947,0.89999999999999858],"text":["diff_base: 0<br />cf: asian race<br />cohort_id: Sample Alternate","diff_base: 0<br />cf: black race<br />cohort_id: Sample Alternate","diff_base: 0<br />cf: female<br />cohort_id: Sample Alternate","diff_base: 0<br />cf: hispanic<br />cohort_id: Sample Alternate","diff_base: 0<br />cf: mixed race<br />cohort_id: Sample Alternate","diff_base: 0<br />cf: other race<br />cohort_id: Sample Alternate","diff_base: 0<br />cf: unknown race<br />cohort_id: Sample Alternate","diff_base: 0<br />cf: white race<br />cohort_id: Sample Alternate","diff_base: 0<br />cf: hypertension<br />cohort_id: Sample Alternate"],"type":"bar","textposition":"none","marker":{"autocolorscale":false,"color":"rgba(255,77,111,1)","line":{"width":1.8897637795275593,"color":"transparent"}},"name":"Sample Alternate","legendgroup":"Sample Alternate","showlegend":false,"xaxis":"x2","yaxis":"y2","hoverinfo":"text","frame":null},{"name":"Sample Alternate","legendgroup":"Sample Alternate","showlegend":false,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null},{"name":"Sample Alternate","legendgroup":"Sample Alternate","showlegend":false,"xaxis":"x2","yaxis":"y2","hoverinfo":"text","frame":null}],"layout":{"margin":{"t":52.529680365296812,"r":7.3059360730593621,"b":37.260273972602747,"l":124.9315068493151},"paper_bgcolor":"rgba(255,255,255,1)","font":{"color":"rgba(0,0,0,1)","family":"","size":14.611872146118724},"title":{"text":"Difference between Alternate and Base Cohorts","font":{"color":"rgba(0,0,0,1)","family":"","size":17.534246575342465},"x":0,"xref":"paper"},"xaxis":{"domain":[0,0.33333333333333331],"automargin":true,"type":"linear","autorange":false,"range":[-0.050000000000000003,0.050000000000000003],"tickmode":"array","ticktext":["-0.050","-0.025","0.000","0.025","0.050"],"tickvals":[-0.050000000000000003,-0.025000000000000001,0,0.025000000000000008,0.050000000000000003],"categoryorder":"array","categoryarray":["-0.050","-0.025","0.000","0.025","0.050"],"nticks":null,"ticks":"","tickcolor":null,"ticklen":3.6529680365296811,"tickwidth":0,"showticklabels":true,"tickfont":{"color":"rgba(77,77,77,1)","family":"","size":11.68949771689498},"tickangle":-0,"showline":false,"linecolor":null,"linewidth":0,"showgrid":true,"gridcolor":"rgba(235,235,235,1)","gridwidth":0,"zeroline":false,"anchor":"y","title":"","hoverformat":".2f"},"annotations":[{"text":"Difference from Base Cohort","x":0.5,"y":0,"showarrow":false,"ax":0,"ay":0,"font":{"color":"rgba(0,0,0,1)","family":"","size":14.611872146118724},"xref":"paper","yref":"paper","textangle":-0,"xanchor":"center","yanchor":"top","annotationType":"axis","yshift":-21.917808219178088},{"text":"Cohort Characteristic","x":0,"y":0.5,"showarrow":false,"ax":0,"ay":0,"font":{"color":"rgba(0,0,0,1)","family":"","size":14.611872146118724},"xref":"paper","yref":"paper","textangle":-90,"xanchor":"right","yanchor":"center","annotationType":"axis","xshift":-109.58904109589045},{"text":"Medians","x":0.16666666666666666,"y":1,"showarrow":false,"ax":0,"ay":0,"font":{"color":"rgba(26,26,26,1)","family":"","size":11.68949771689498},"xref":"paper","yref":"paper","textangle":-0,"xanchor":"center","yanchor":"bottom"},{"text":"Proportions","x":0.83333333333333337,"y":1,"showarrow":false,"ax":0,"ay":0,"font":{"color":"rgba(26,26,26,1)","family":"","size":11.68949771689498},"xref":"paper","yref":"paper","textangle":-0,"xanchor":"center","yanchor":"bottom"}],"yaxis":{"domain":[0,1],"automargin":true,"type":"linear","autorange":false,"range":[0.40000000000000002,5.5999999999999996],"tickmode":"array","ticktext":["all conditions","age cohort entry","age first visit","follow-up","outpatient visits"],"tickvals":[1,2,3,4,5],"categoryorder":"array","categoryarray":["all conditions","age cohort entry","age first visit","follow-up","outpatient visits"],"nticks":null,"ticks":"","tickcolor":null,"ticklen":3.6529680365296811,"tickwidth":0,"showticklabels":true,"tickfont":{"color":"rgba(77,77,77,1)","family":"","size":11.68949771689498},"tickangle":-0,"showline":false,"linecolor":null,"linewidth":0,"showgrid":true,"gridcolor":"rgba(235,235,235,1)","gridwidth":0,"zeroline":false,"anchor":"x","title":"","hoverformat":".2f"},"shapes":[{"type":"rect","fillcolor":null,"line":{"color":null,"width":0,"linetype":[]},"yref":"paper","xref":"paper","layer":"below","x0":0,"x1":0.33333333333333331,"y0":0,"y1":1},{"type":"rect","fillcolor":null,"line":{"color":null,"width":0,"linetype":[]},"yref":"paper","xref":"paper","layer":"below","x0":0,"x1":0.33333333333333331,"y0":0,"y1":23.37899543378996,"yanchor":1,"ysizemode":"pixel"},{"type":"rect","fillcolor":null,"line":{"color":null,"width":0,"linetype":[]},"yref":"paper","xref":"paper","layer":"below","x0":0.66666666666666674,"x1":1,"y0":0,"y1":1},{"type":"rect","fillcolor":null,"line":{"color":null,"width":0,"linetype":[]},"yref":"paper","xref":"paper","layer":"below","x0":0.66666666666666674,"x1":1,"y0":0,"y1":23.37899543378996,"yanchor":1,"ysizemode":"pixel"}],"xaxis2":{"type":"linear","autorange":false,"range":[-0.050000000000000003,0.050000000000000003],"tickmode":"array","ticktext":["-0.050","-0.025","0.000","0.025","0.050"],"tickvals":[-0.050000000000000003,-0.025000000000000001,0,0.025000000000000008,0.050000000000000003],"categoryorder":"array","categoryarray":["-0.050","-0.025","0.000","0.025","0.050"],"nticks":null,"ticks":"","tickcolor":null,"ticklen":3.6529680365296811,"tickwidth":0,"showticklabels":true,"tickfont":{"color":"rgba(77,77,77,1)","family":"","size":11.68949771689498},"tickangle":-0,"showline":false,"linecolor":null,"linewidth":0,"showgrid":true,"domain":[0.66666666666666674,1],"gridcolor":"rgba(235,235,235,1)","gridwidth":0,"zeroline":false,"anchor":"y2","title":"","hoverformat":".2f"},"yaxis2":{"type":"linear","autorange":false,"range":[0.40000000000000002,9.5999999999999996],"tickmode":"array","ticktext":["asian race","black race","female","hispanic","mixed race","other race","unknown race","white race","hypertension"],"tickvals":[1,2,3,4,5,6,6.9999999999999991,8,9],"categoryorder":"array","categoryarray":["asian race","black race","female","hispanic","mixed race","other race","unknown race","white race","hypertension"],"nticks":null,"ticks":"","tickcolor":null,"ticklen":3.6529680365296811,"tickwidth":0,"showticklabels":true,"tickfont":{"color":"rgba(77,77,77,1)","family":"","size":11.68949771689498},"tickangle":-0,"showline":false,"linecolor":null,"linewidth":0,"showgrid":true,"domain":[0,1],"gridcolor":"rgba(235,235,235,1)","gridwidth":0,"zeroline":false,"anchor":"x2","title":"","hoverformat":".2f"},"showlegend":true,"legend":{"bgcolor":null,"bordercolor":null,"borderwidth":0,"font":{"color":"rgba(0,0,0,1)","family":"","size":11.68949771689498},"title":{"text":"Alternate Cohort","font":{"color":"rgba(0,0,0,1)","family":"","size":14.611872146118724}}},"hovermode":"closest","barmode":"relative"},"config":{"doubleClick":"reset","modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false},"source":"A","attrs":{"19642898c209":{"x":{},"y":{},"fill":{},"type":"bar"},"196447d6bd09":{"x":{},"y":{},"fill":{},"label":{}}},"cur_data":"19642898c209","visdat":{"19642898c209":["function (y) ","x"],"196447d6bd09":["function (y) ","x"]},"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.20000000000000001,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}
```
